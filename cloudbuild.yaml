steps:
  - name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - --destination=gcr.io/$PROJECT_ID/survaq-jobs/$_BUILD_CONTEXT:$COMMIT_SHA
      - --destination=gcr.io/$PROJECT_ID/survaq-jobs/$_BUILD_CONTEXT:latest
      - --cache=true
      - --build-arg=BUILD_CONTEXT=$_BUILD_CONTEXT

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'beta'
      - 'run'
      - 'jobs'
      - 'update' # or create
      - 'survaq-jobs-$_BUILD_CONTEXT'
      - '--region'
      - 'europe-west9'
      - '--set-env-vars'
      - '$_ENV_VARS'
      - '--service-account'
      - '$_SERVICE_ACCOUNT'

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - 'scheduler'
      - 'jobs'
      - 'create' # or create
      - 'http'
      - 'survaq-jobs-$_BUILD_CONTEXT-scheduler'
      - '--location'
      - 'asia-northeast1-a'
      - '--schedule'
      - '"0 * * * *"'
      - '--uri'
      - '"https://europe-west9-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/$PROJECT_ID/jobs/survaq-jobs-$_BUILD_CONTEXT:run"'
      - '--http-method'
      - 'POST'
      - '--oauth-service-account-email'
      - '$PROJECT_NUMBER-compute@developer.gserviceaccount.com'
      - '--time-zone'
      - 'Asia/Tokyo'

substitutions:
  _BUILD_CONTEXT: ''
  _ENV_VARS: ''
  _SERVICE_ACCOUNT: ''